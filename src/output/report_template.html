<!DOCTYPE html>
<!--suppress TypeScriptMissingConfigOption -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Git Blame Statistics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-3.3.0.min.js" charset="utf-8"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- React 18 UMD builds -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel Standalone for in-browser JSX transform -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 900px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.05); }
        h1, h2 { border-bottom: 1px solid #dee2e6; padding-bottom: 10px; }
        .chart-container { margin-top: 20px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-presets="react">
        const RAW_DATASET =
            __DATASET_JSON__
            || [];
        // Fixed schema as per pipeline: [author, days_bucket, lang, clusterPath, repoName, count]
        const HEADER_LABELS = ["author","days_bucket","lang","clusterPath","repoName","count"];
        // -------- Client-side grouping/filtering engine --------
        const KEY_INDEX = Object.fromEntries(HEADER_LABELS.map((k,i)=>[k,i]));
        const COUNT_IDX_FROM_END = 1; // last element is count

        const allKeys = HEADER_LABELS.filter(k => k !== 'count');

        function uniqueValues(arr, idx){
          const set = new Set(arr.map(r => r[idx]));
          return Array.from(set);
        }

        function pivot(
            dataset,
            primaryKeyIndex,
            secondaryKeyIndex,
            filterState
        ) {
            const pivot = new Map();
          const totals = new Map();
          const secValuesSet = new Set();
          for (const row of dataset) {
            let ok = true;
            for (const key of allKeys) {
              const idx = KEY_INDEX[key];
              const sel = filterState[key];
              if (sel && !sel.has(String(row[idx]))) { ok = false; break; }
            }
            if (!ok) continue;
            const pk = row[primaryKeyIndex];
            const sk = row[secondaryKeyIndex];
            const count = Number(row[row.length - COUNT_IDX_FROM_END]) || 0;
            if (!pivot.has(pk)) pivot.set(pk, new Map());
            const inner = pivot.get(pk);
            inner.set(sk, (inner.get(sk)||0)+count);
            totals.set(pk, (totals.get(pk)||0)+count);
            secValuesSet.add(sk);
          }
          let primaryKeys = Array.from(pivot.keys());
          primaryKeys.sort((a,b)=> (totals.get(b)||0) - (totals.get(a)||0));
          let secondaryKeys = Array.from(secValuesSet);
          secondaryKeys.sort((a,b)=>String(a).localeCompare(String(b)));
          return {pivot, totals, primaryKeys, secondaryKeys};
        }

        // ---------- React Components ----------
        function ChartView({ labels, datasets }){
          const canvasRef = React.useRef(null);
          const chartRef = React.useRef(null);
          React.useEffect(()=>{
            const ctx = canvasRef.current.getContext('2d');
            chartRef.current = new Chart(ctx, {
              type: 'bar',
              data: { labels: [], datasets: [] },
              options: {
                indexAxis: 'y',
                scales: {
                  x: { stacked: true, beginAtZero: true },
                  y: { stacked: true, ticks: { autoSkip: false } }
                },
                plugins: {
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) label += ': ';
                        if (context.parsed.x !== null) label += context.parsed.x.toLocaleString();
                        return label;
                      }
                    }
                  }
                }
              }
            });
            return ()=>{ chartRef.current && chartRef.current.destroy(); };
          }, []);

          React.useEffect(()=>{
            if (!chartRef.current) return;
            chartRef.current.data.labels = labels;
            chartRef.current.data.datasets = datasets;
            chartRef.current.update();
          }, [labels, datasets]);

          return <canvas ref={canvasRef} />;
        }

        function MultiSelect({ label, values, selectedSet, onChange }){
          const selCount = selectedSet.size;
          const total = values.length;
          return (
            <div>
              <label style={{ display:'block', fontWeight:600, marginBottom:'6px' }}>
                {label}{' '}
                <span style={{ color:'#6c757d', fontWeight:400 }}>({selCount}/{total})</span>
              </label>
              <select
                multiple
                size={Math.min(8, Math.max(3, values.length))}
                style={{ width: '100%' }}
                onChange={(e)=>{
                  const chosen = Array.from(e.target.selectedOptions).map(o=>o.value);
                  onChange(new Set(chosen));
                }}
              >
                {values.map(v=> (
                  <option key={String(v)} value={String(v)} selected={selectedSet.has(String(v))}>
                    {String(v)}
                  </option>
                ))}
              </select>
            </div>
          );
        }

        function App(){
          const allKeysLocal = allKeys;
          // initialize filters with all selected
          const initialFilters = React.useMemo(()=>{
            const f = {};
            for (const key of allKeysLocal) {
              const idx = KEY_INDEX[key];
              const values = uniqueValues(RAW_DATASET, idx);
              f[key] = new Set(values.map(v=>String(v)));
            }
            return f;
          }, []);
          const [filters, setFilters] = React.useState(initialFilters);
            const [primaryKeyIndex, setPrimaryKeyIndex] = React.useState(0);
            const [secondaryKeyIndex, setSecondaryKeyIndex] = React.useState(1);

            const valueOptions = React.useMemo(()=>{
            const map = {};
            for (const key of allKeysLocal) {
              const idx = KEY_INDEX[key];
              const values = uniqueValues(RAW_DATASET, idx).sort((a,b)=>{
                if (key==='days_bucket') return Number(a)-Number(b);
                return String(a).localeCompare(String(b));
              });
              map[key] = values;
            }
            return map;
          }, []);

          const { chartLabels, datasets, titleText } = React.useMemo(()=>{
              const {
                  pivot: pv,
                  totals,
                  primaryKeys,
                  secondaryKeys
              } = pivot(RAW_DATASET, primaryKeyIndex, secondaryKeyIndex, filters);
              const topN = 20;
            const chartPrimaryKeys = primaryKeys.slice(0, topN);
            const bucketColors = ['rgba(214, 40, 40, 0.7)','rgba(247, 127, 0, 0.7)','rgba(252, 191, 73, 0.7)','rgba(168, 218, 142, 0.7)','rgba(75, 192, 192, 0.7)','rgba(54, 162, 235, 0.7)','rgba(153, 102, 255, 0.7)','rgba(201, 203, 207, 0.7)'];
            const ds = secondaryKeys.map((sk,i)=>({
              label: String(sk),
              data: chartPrimaryKeys.map(pk => (pv.get(pk)?.get(sk)) || 0),
              backgroundColor: bucketColors[i % bucketColors.length]
            }));
            const title = ``;
            return { chartLabels: chartPrimaryKeys, datasets: ds, titleText: title };
          }, [filters, primaryKeyIndex, secondaryKeyIndex]);

            return (
            <div className="container">
              <h1>Git Contribution Statistics</h1>
              <div className="controls">
                <h2>Controls</h2>
                <div style={{ display:'flex', gap:'16px', flexWrap:'wrap', alignItems:'center' }}>
                  <label>
                    Primary group:
                      <select value={primaryKeyIndex} onChange={e => setPrimaryKeyIndex(Number(e.target.value))}>
                          {allKeysLocal.map((k, i) => (
                              <option key={k} value={i}>{k}</option>
                          ))}
                      </select>
                  </label>
                    <label>
                        Secondary group:
                        <select value={secondaryKeyIndex} onChange={e => setSecondaryKeyIndex(Number(e.target.value))}>
                            {allKeysLocal.map((k, i) => (
                                <option key={k} value={i}>{k}</option>
                            ))}
                    </select>
                  </label>
                </div>
                <div id="filters" style={{ marginTop:'12px', display:'grid', gridTemplateColumns:'repeat(auto-fit,minmax(220px,1fr))', gap:'12px' }}>
                  {allKeysLocal.map(key => (
                    <MultiSelect
                      key={key}
                      label={key}
                      values={valueOptions[key]}
                      selectedSet={filters[key]}
                      onChange={(newSet)=> setFilters(prev=>({ ...prev, [key]: newSet }))}
                    />
                  ))}
                </div>
              </div>
              <div className="chart-container" style={{ marginTop:'20px' }}>
                <h2 id="chartTitle">{titleText}</h2>
                <ChartView labels={chartLabels} datasets={datasets} />
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
  </body>
</html>
