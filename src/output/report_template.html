<!DOCTYPE html>
<!--suppress TypeScriptMissingConfigOption -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Git Blame Statistics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-3.3.0.min.js" charset="utf-8"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- React 18 UMD builds -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel Standalone for in-browser JSX transform -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="font-sans m-0 bg-gray-50 text-gray-900">
<div id="root"></div>
    <script type="text/babel" data-presets="react">
        import React from "react";

        const RAW_DATASET =
            __DATASET_JSON__
            || [];
        // Fixed schema as per pipeline: [author, days_bucket, lang, clusterPath, repoName, count]
        const HEADER_LABELS = ["author","days_bucket","lang","clusterPath","repoName","count"];
        // -------- Client-side grouping/filtering engine --------
        const KEY_INDEX = Object.fromEntries(HEADER_LABELS.map((k,i)=>[k,i]));
        const COUNT_IDX_FROM_END = 1; // last element is count

        const allKeys = HEADER_LABELS.filter(k => k !== 'count');
        const TOP_N = 20;
        const BUCKET_COLORS = [
            'rgba(214, 40, 40, 0.7)',
            'rgba(247, 127, 0, 0.7)',
            'rgba(252, 191, 73, 0.7)',
            'rgba(168, 218, 142, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(153, 102, 255, 0.7)',
            'rgba(201, 203, 207, 0.7)'
        ];

        function uniqueValues(arr, idx){
          const set = new Set(arr.map(r => r[idx]));
          return Array.from(set);
        }

        function matchesFilters(row, filterState) {
            for (const key of allKeys) {
                const idx = KEY_INDEX[key];
                const sel = filterState[key];
                if (sel && !sel.has(String(row[idx]))) return false;
            }
            return true;
        }

        function sortByBucket(a, b, key) {
            if (key === 'days_bucket') return Number(a) - Number(b);
            return String(a).localeCompare(String(b));
        }

        function pivot(
            dataset,
            primaryKeyIndex,
            secondaryKeyIndex,
            filterState
        ) {
            const pivot = new Map();
            const totals = new Map();
            const secValuesSet = new Set();
            for (const row of dataset) {
                if (!matchesFilters(row, filterState)) continue;
                const pk = row[primaryKeyIndex];
            const sk = row[secondaryKeyIndex];
            const count = Number(row[row.length - COUNT_IDX_FROM_END]) || 0;
            if (!pivot.has(pk)) pivot.set(pk, new Map());
              pivot.get(pk).set(sk, (pivot.get(pk).get(sk) || 0) + count);
              totals.set(pk, (totals.get(pk) || 0) + count);
              secValuesSet.add(sk);
          }
            const primaryKeys = Array.from(pivot.keys()).sort((a, b) => (totals.get(b) || 0) - (totals.get(a) || 0));
            const secondaryKeys = Array.from(secValuesSet).sort((a, b) => String(a).localeCompare(String(b)));
            return {pivot, totals, primaryKeys, secondaryKeys};
        }

        // ---------- React Components ----------
        const CHART_OPTIONS = {
            indexAxis: 'y',
            scales: {
                x: {stacked: true, beginAtZero: true},
                y: {stacked: true, ticks: {autoSkip: false}}
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            if (context.parsed.x !== null) label += context.parsed.x.toLocaleString();
                            return label;
                        }
                    }
                }
            }
        };

        function ChartView({labels, datasets}) {
            const canvasRef = React.useRef(null);
            const chartRef = React.useRef(null);
            React.useEffect(() => {
                chartRef.current = new Chart(canvasRef.current.getContext('2d'), {
                    type: 'bar',
                    data: {labels: [], datasets: []},
                    options: CHART_OPTIONS
                });
            return ()=>{ chartRef.current && chartRef.current.destroy(); };
          }, []);

          React.useEffect(()=>{
            if (!chartRef.current) return;
            chartRef.current.data.labels = labels;
            chartRef.current.data.datasets = datasets;
            chartRef.current.update();
          }, [labels, datasets]);

          return <canvas ref={canvasRef} />;
        }

        function MultiSelect({ label, values, selectedSet, onChange }){
            return (
                <div>
                    <label className="block font-semibold mb-1.5">
                        {label}{' '}
                        <span className="text-gray-600 font-normal">({selectedSet.size}/{values.length})</span>
                    </label>
                    <select
                        multiple
                        size={Math.min(8, Math.max(3, values.length))}
                        className="w-full"
                        onChange={(e) => {
                            onChange(new Set(Array.from(e.target.selectedOptions).map(o => o.value)));
                        }}
              >
                  {values.map(v => {
                      const strVal = String(v);
                      return (
                          <option key={strVal} value={strVal} selected={selectedSet.has(strVal)}>
                              {strVal}
                          </option>
                      );
                  })}
              </select>
            </div>
          );
        }

        function App(){
            const {initialFilters, valueOptions} = React.useMemo(() => {
                const filters = {};
                const options = {};
                for (const key of allKeys) {
                    const idx = KEY_INDEX[key];
                    const values = uniqueValues(RAW_DATASET, idx).sort((a, b) => sortByBucket(a, b, key));
                    filters[key] = new Set(values.map(v => String(v)));
                    options[key] = values;
                }
                return {initialFilters: filters, valueOptions: options};
            }, []);
            const [filters, setFilters] = React.useState(initialFilters);
            const [primaryKeyIndex, setPrimaryKeyIndex] = React.useState(0);
            const [secondaryKeyIndex, setSecondaryKeyIndex] = React.useState(1);

            const {chartLabels, datasets} = React.useMemo(() => {
                const {
                    pivot: pv,
                    primaryKeys,
                    secondaryKeys
                } = pivot(RAW_DATASET, primaryKeyIndex, secondaryKeyIndex, filters);
                const chartPrimaryKeys = primaryKeys.slice(0, TOP_N);
                const ds = secondaryKeys.map((sk, i) => ({
                    label: String(sk),
                    data: chartPrimaryKeys.map(pk => (pv.get(pk)?.get(sk)) || 0),
                    backgroundColor: BUCKET_COLORS[i % BUCKET_COLORS.length]
                }));
                return {chartLabels: chartPrimaryKeys, datasets: ds};
            }, [filters, primaryKeyIndex, secondaryKeyIndex]);

            return (
                <div className="max-w-4xl mx-auto my-5 p-5 bg-white rounded-lg shadow-sm">
                    <h1 className="border-b border-gray-300 pb-2.5">Git Contribution Statistics</h1>
                    <div className="controls">
                        <h2 className="border-b border-gray-300 pb-2.5">Controls</h2>
                        <div className="flex gap-4 flex-wrap items-center">
                        <label>
                    Primary group:
                      <select value={primaryKeyIndex} onChange={e => setPrimaryKeyIndex(Number(e.target.value))}>
                          {allKeys.map((__, i) => (
                              <option key={i} value={i}>{HEADER_LABELS[i]}</option>
                          ))}
                      </select>
                        </label>
                            <label>
                                Secondary group:
                                <select value={secondaryKeyIndex}
                                        onChange={e => setSecondaryKeyIndex(Number(e.target.value))}>
                                    {allKeys.map((__, i) => (
                                        <option key={i} value={i}>{HEADER_LABELS[i]}</option>
                                    ))}
                                </select>
                            </label>
                        </div>
                        <div id="filters" className="mt-3 grid grid-cols-[repeat(auto-fit,minmax(220px,1fr))] gap-3">
                            {allKeys.map((key, idx) => (
                                    <MultiSelect
                      key={idx}
                      label={HEADER_LABELS[idx]}
                      values={valueOptions[key]}
                      selectedSet={filters[key]}
                      onChange={(newSet)=> setFilters(prev=>({ ...prev, [key]: newSet }))}
                    />
                  ))}
                </div>
              </div>
                    <div className="mt-5">
                        <h2 id="chartTitle" className="border-b border-gray-300 pb-2.5">Chart</h2>
                        <ChartView labels={chartLabels} datasets={datasets} />
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
  </body>
</html>
